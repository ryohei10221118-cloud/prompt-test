<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
<title>è§’è‰²åˆ†é¡ç®¡ç†å·¥å…·</title>

<style>
:root {
  --primary: linear-gradient(135deg, #7b5cff, #6a9cff);
  --bg-color: #f4f5ff;
  --card-bg: #ffffff;
  --accent: #806cff;
  --shadow: rgba(0, 0, 0, 0.15);
  --gray-text: #555;
}

/* é é¢æ•´é«”è¨­å®š */
body {
  margin: 0;
  font-family: "Noto Sans TC", sans-serif;
  background: var(--bg-color);
  color: #222;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  overflow-x: hidden;
}

/* é é¦– */
header {
  width: 100%;
  text-align: center;
  background: var(--primary);
  color: white;
  padding: 18px 10px;
  font-size: clamp(1.3em, 2.5vw, 1.8em);
  font-weight: bold;
  letter-spacing: 1px;
  box-shadow: 0 3px 10px var(--shadow);
  position: sticky;
  top: 0;
  z-index: 100;
}

/* å°è¦½åˆ— */
.navbar {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 10px;
  justify-content: center;
  background: rgba(255,255,255,0.45);
  backdrop-filter: blur(6px);
  box-shadow: 0 2px 6px var(--shadow);
  width: 100%;
}
.navbar button {
  flex: 0 1 auto;
  border: none;
  background: var(--accent);
  color: white;
  padding: 8px 14px;
  border-radius: 20px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.2s ease;
  white-space: nowrap;
}
.navbar button:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

/* åˆ†é¡å®¹å™¨ */
.category {
  width: 95%;
  max-width: 1000px;
  background: var(--card-bg);
  margin: 18px auto;
  border-radius: 16px;
  box-shadow: 0 3px 10px var(--shadow);
  padding: 16px;
}

/* åˆ†é¡æ¨™é¡Œ */
.category-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 1.2em;
  font-weight: bold;
  color: var(--accent);
  margin-bottom: 10px;
  flex-wrap: wrap;
}
.category-header button {
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 20px;
  padding: 6px 12px;
  cursor: pointer;
  font-size: 0.9em;
}
.category-header button:hover {
  opacity: 0.9;
}

/* å¡ç‰‡å€å¡Š */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 12px;
}
.card {
  background: white;
  border-radius: 14px;
  box-shadow: 0 3px 6px var(--shadow);
  padding: 14px;
  cursor: pointer;
  transition: 0.25s;
}
.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 12px var(--shadow);
}
.card-title {
  font-weight: bold;
  color: var(--accent);
  margin-bottom: 8px;
}
.card-desc {
  font-size: 0.95em;
  color: var(--gray-text);
  background: #f6f6ff;
  padding: 8px 10px;
  border-radius: 10px;
  min-height: 50px;
}

/* å½ˆçª—é€šç”¨ */
.modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.45);
  justify-content: center;
  align-items: center;
  z-index: 200;
}
.modal-content {
  background: white;
  padding: 25px;
  border-radius: 14px;
  box-shadow: 0 4px 10px var(--shadow);
  width: 90%;
  max-width: 420px;
  text-align: center;
  position: relative;
}
.modal-content h3 {
  margin-top: 0;
  color: var(--accent);
}
.modal-content input, .modal-content textarea {
  width: 90%;
  padding: 10px;
  margin-top: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 1em;
}
.modal-content button {
  margin-top: 15px;
  background: var(--primary);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
}
.close-btn {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 1.2em;
  cursor: pointer;
  color: #888;
}
.close-btn:hover { color: #000; }

/* å°å»ºè­°æŒ‰éˆ• */
#suggestionBtn {
  position: fixed;
  bottom: 25px;
  right: 25px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 50%;
  width: 55px;
  height: 55px;
  box-shadow: 0 4px 10px var(--shadow);
  font-size: 1.3em;
  cursor: pointer;
  z-index: 150;
  transition: 0.3s;
}
#suggestionBtn:hover { transform: scale(1.05); }

/* å›é ‚æŒ‰éˆ• */
#scrollTopBtn {
  position: fixed;
  bottom: 90px;
  right: 30px;
  background: #6a9cff;
  color: white;
  border: none;
  border-radius: 50%;
  width: 45px;
  height: 45px;
  font-size: 1.1em;
  cursor: pointer;
  display: none;
  box-shadow: 0 4px 10px var(--shadow);
  transition: 0.3s;
  z-index: 150;
}
#scrollTopBtn:hover { transform: scale(1.1); }

/* ç™»å…¥çª— */
#loginModal .modal-content {
  max-width: 360px;
}
#loginModal input {
  width: 100%;
  margin-bottom: 10px;
}
#loginModal button {
  width: 100%;
  margin-top: 10px;
}

/* æ‰‹æ©Ÿé©æ‡‰ */
@media (max-width: 600px) {
  header { font-size: 1.5em; padding: 15px 8px; }
  .category { padding: 14px; }
  .navbar button { padding: 6px 10px; font-size: 0.9em; }
  .modal-content { width: 92%; padding: 20px; }
}
</style>

  </head>
<body>

<header>è§’è‰²ç®¡ç†å·¥å…·</header>

<!-- å°è¦½åˆ— -->
<div class="navbar">
  <button id="loginBtn">ç™»å…¥ / ç™»å‡º</button>
  <button id="addCategoryBtn">ï¼‹ æ–°å¢åˆ†é¡</button>
</div>

<!-- é¡åˆ¥å®¹å™¨ -->
<div id="categoriesContainer"></div>

<!-- å°å»ºè­°æŒ‰éˆ• -->
<button id="suggestionBtn" title="æå‡ºå°å»ºè­°">ğŸ’¡</button>

<!-- å›åˆ°æœ€ä¸Šæ–¹ -->
<button id="scrollTopBtn" title="å›åˆ°æœ€ä¸Šæ–¹">â†‘</button>

<!-- ç™»å…¥è¦–çª— -->
<div id="loginModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeLogin()">Ã—</span>
    <h3>ç™»å…¥æˆ–è¨»å†Šå¸³è™Ÿ</h3>
    <input type="text" id="loginAccount" placeholder="å¸³è™Ÿ" />
    <input type="password" id="loginPassword" placeholder="å¯†ç¢¼" />
    <button onclick="loginOrRegister()">ç™»å…¥ / è¨»å†Š</button>
  </div>
</div>

<!-- å°å»ºè­°è¦–çª— -->
<div id="suggestionModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeSuggestion()">Ã—</span>
    <h3>æå‡ºå°å»ºè­°</h3>
    <textarea id="suggestionText" rows="5" placeholder="è¼¸å…¥ä½ çš„å»ºè­°..."></textarea>
    <button onclick="submitSuggestion()">é€å‡º</button>
  </div>
</div>

<script>
// --- Firebase åˆå§‹åŒ– ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "ä½ çš„APIKEY",
  authDomain: "ä½ çš„å°ˆæ¡ˆ.firebaseapp.com",
  projectId: "ä½ çš„å°ˆæ¡ˆID",
  storageBucket: "ä½ çš„å°ˆæ¡ˆ.appspot.com",
  messagingSenderId: "ä½ çš„senderId",
  appId: "ä½ çš„appId"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// --- ç™»å…¥ / ç™»å‡º ---
const loginBtn = document.getElementById("loginBtn");
const loginModal = document.getElementById("loginModal");
let currentUser = null;

loginBtn.addEventListener("click", () => {
  if (currentUser) {
    signOut(auth).then(() => {
      currentUser = null;
      alert("å·²ç™»å‡ºï¼");
      loginBtn.textContent = "ç™»å…¥ / ç™»å‡º";
    });
  } else {
    loginModal.style.display = "flex";
  }
});

async function loginOrRegister() {
  const account = document.getElementById("loginAccount").value;
  const password = document.getElementById("loginPassword").value;
  try {
    await signInWithEmailAndPassword(auth, account, password);
  } catch (error) {
    await createUserWithEmailAndPassword(auth, account, password);
  }
  closeLogin();
}

function closeLogin() {
  loginModal.style.display = "none";
}

onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
    loginBtn.textContent = "ç™»å‡º";
  } else {
    currentUser = null;
    loginBtn.textContent = "ç™»å…¥ / ç™»å‡º";
  }
});

// --- å°å»ºè­° ---
const suggestionModal = document.getElementById("suggestionModal");
document.getElementById("suggestionBtn").onclick = () => {
  suggestionModal.style.display = "flex";
};
function closeSuggestion() {
  suggestionModal.style.display = "none";
}
async function submitSuggestion() {
  const text = document.getElementById("suggestionText").value.trim();
  if (!text) return alert("è«‹è¼¸å…¥å…§å®¹ï¼");
  try {
    await addDoc(collection(db, "suggestions"), {
      text,
      user: currentUser ? currentUser.email : "è¨ªå®¢",
      time: new Date()
    });
    alert("æ„Ÿè¬ä½ çš„å»ºè­°ï¼");
    document.getElementById("suggestionText").value = "";
    closeSuggestion();
  } catch (e) {
    console.error("Error adding document: ", e);
  }
}

// --- å›åˆ°æœ€ä¸Šæ–¹æŒ‰éˆ• ---
const scrollBtn = document.getElementById("scrollTopBtn");
window.addEventListener("scroll", () => {
  scrollBtn.style.display = window.scrollY > 200 ? "block" : "none";
});
scrollBtn.onclick = () => window.scrollTo({ top: 0, behavior: "smooth" });

  // --- è§’è‰²è©³æƒ…è¦–çª— ---
const categoriesContainer = document.getElementById("categoriesContainer");

// å»ºç«‹è§’è‰²é¡¯ç¤º
async function loadCategories() {
  const q = query(collection(db, "categories"), orderBy("createdAt", "desc"));
  const querySnapshot = await getDocs(q);
  categoriesContainer.innerHTML = "";
  querySnapshot.forEach((docSnap) => {
    const categoryData = docSnap.data();
    const categoryDiv = document.createElement("div");
    categoryDiv.className = "category";

    // é¡åˆ¥æ¨™é¡Œ
    const header = document.createElement("div");
    header.className = "category-header";
    header.innerHTML = `
      <span>${categoryData.name}</span>
      ${currentUser ? `<button onclick="deleteCategory('${docSnap.id}')">ğŸ—‘ï¸ åˆªé™¤</button>` : ""}
    `;
    categoryDiv.appendChild(header);

    // è§’è‰²å¡ç‰‡ç¾¤
    const cardsDiv = document.createElement("div");
    cardsDiv.className = "cards";
    if (categoryData.characters) {
      categoryData.characters.forEach((ch) => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `<div class="card-title">${ch.name}</div><div class="card-desc">${ch.short}</div>`;
        card.onclick = () => showCharacterModal(ch);
        cardsDiv.appendChild(card);
      });
    }
    categoryDiv.appendChild(cardsDiv);
    categoriesContainer.appendChild(categoryDiv);
  });
}

// é¡¯ç¤ºè§’è‰²è©³æƒ…
function showCharacterModal(ch) {
  const modal = document.createElement("div");
  modal.className = "modal";
  modal.style.display = "flex";

  modal.innerHTML = `
    <div class="modal-content">
      <span class="close-btn" onclick="this.closest('.modal').remove()">Ã—</span>
      <h3>${ch.name}</h3>
      <div style="background:#f2f2ff; padding:10px; border-radius:10px; margin:10px 0;">${ch.full}</div>
      <button id="copyPromptBtn">ğŸ“‹ è¤‡è£½ Prompt</button>
    </div>
  `;

  document.body.appendChild(modal);
  modal.querySelector("#copyPromptBtn").onclick = () => {
    navigator.clipboard.writeText(ch.full);
    alert("å·²è¤‡è£½ Promptï¼");
  };
}

// åˆªé™¤åˆ†é¡ï¼ˆéœ€è¼¸å…¥ç¢ºèªï¼‰
async function deleteCategory(id) {
  const input = prompt("ç¢ºèªåˆªé™¤è«‹è¼¸å…¥ã€Œåˆªé™¤ã€");
  if (input === "åˆªé™¤") {
    await deleteDoc(doc(db, "categories", id));
    alert("å·²åˆªé™¤åˆ†é¡");
    loadCategories();
  }
}

// åˆå§‹è¼‰å…¥
loadCategories();

  /* ===================== æ–°å¢åˆ†é¡å°è©±æ¡† ===================== */
const addCategoryModal = document.createElement("div");
addCategoryModal.className = "modal";
addCategoryModal.innerHTML = `
  <div class="modal-content">
    <span class="close-btn" onclick="addCategoryModal.style.display='none'">Ã—</span>
    <h3>æ–°å¢åˆ†é¡</h3>
    <input type="text" id="categoryNameInput" placeholder="è«‹è¼¸å…¥åˆ†é¡åç¨±">
    <div class="modal-btns">
      <button id="confirmAddCategory" class="btn-primary">æ–°å¢</button>
      <button onclick="addCategoryModal.style.display='none'" class="btn-secondary">å–æ¶ˆ</button>
    </div>
  </div>
`;
document.body.appendChild(addCategoryModal);

// é–‹å•Ÿåˆ†é¡å°è©±æ¡†
document.getElementById("addCategoryBtn").onclick = () => {
  if (!currentUser) return alert("è«‹å…ˆç™»å…¥ï¼");
  addCategoryModal.style.display = "flex";
};

// å„²å­˜åˆ†é¡
document.getElementById("confirmAddCategory").onclick = async () => {
  const name = document.getElementById("categoryNameInput").value.trim();
  if (!name) return alert("è«‹è¼¸å…¥åˆ†é¡åç¨±ï¼");
  try {
    await addDoc(collection(db, "categories"), {
      name,
      createdAt: new Date(),
      characters: []
    });
    alert("åˆ†é¡æ–°å¢å®Œæˆï¼");
    addCategoryModal.style.display = "none";
    document.getElementById("categoryNameInput").value = "";
    loadCategories();
  } catch (e) {
    console.error("Error adding category:", e);
  }
};

/* ===================== æ–°å¢è§’è‰²å°è©±æ¡† ===================== */
const addCharacterModal = document.createElement("div");
addCharacterModal.className = "modal";
addCharacterModal.innerHTML = `
  <div class="modal-content">
    <span class="close-btn" onclick="addCharacterModal.style.display='none'">Ã—</span>
    <h3>æ–°å¢è§’è‰²</h3>
    <input type="text" id="charName" placeholder="è§’è‰²åç¨±">
    <textarea id="charFull" rows="4" placeholder="è§’è‰²æè¿° / Prompt"></textarea>
    <div class="modal-btns">
      <button id="saveCharacterBtn" class="btn-primary">æ–°å¢</button>
      <button onclick="addCharacterModal.style.display='none'" class="btn-secondary">å–æ¶ˆ</button>
    </div>
  </div>
`;
document.body.appendChild(addCharacterModal);

let currentCategoryId = null;
function showAddCharacter(categoryId) {
  if (!currentUser) return alert("è«‹å…ˆç™»å…¥ï¼");
  currentCategoryId = categoryId;
  addCharacterModal.style.display = "flex";
}

document.getElementById("saveCharacterBtn").onclick = async () => {
  const name = document.getElementById("charName").value.trim();
  const full = document.getElementById("charFull").value.trim();
  if (!name || !full) return alert("è«‹å®Œæ•´å¡«å¯«è§’è‰²è³‡æ–™ï¼");
  try {
    const catRef = doc(db, "categories", currentCategoryId);
    const catSnap = await getDoc(catRef);
    if (catSnap.exists()) {
      const existing = catSnap.data().characters || [];
      existing.push({ name, short: full.substring(0, 100) + "...", full });
      await updateDoc(catRef, { characters: existing });
      alert("è§’è‰²æ–°å¢å®Œæˆï¼");
      addCharacterModal.style.display = "none";
      loadCategories();
    }
  } catch (e) {
    console.error("Error adding character:", e);
  }
};

</script>
</body>
</html>
