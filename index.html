<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è§’è‰²ç®¡ç†å·¥å…·</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Noto Sans TC', sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f3f5fc;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      color: #4a3aff;
      margin-top: 20px;
      text-shadow: 0 0 6px rgba(74, 58, 255, 0.2);
    }

    /* ğŸ”¹ å°è¦½åˆ— */
    .category-nav {
      display: flex;
      overflow-x: auto;
      gap: 10px;
      padding: 10px;
      margin: 10px 0;
      background: transparent;
      position: relative;
      width: 90%;
      justify-content: flex-start;
      align-items: center;
    }

    .category-nav button {
      background: linear-gradient(135deg, #7a7aff, #a479ff);
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      transition: 0.2s;
    }

    .category-nav button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 8px rgba(100, 80, 255, 0.5);
    }

    /* ğŸ”¹ åˆ†é¡æ¨™é¡Œå€ */
    .category-section {
      width: 90%;
      margin: 30px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }

    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .category-header h2 {
      margin: 0;
      color: #4a3aff;
    }

    .category-actions {
      display: flex;
      gap: 8px;
    }

    .category-actions button {
      border: none;
      border-radius: 8px;
      cursor: pointer;
      padding: 6px 10px;
      color: white;
      background: #6a5aff;
      transition: 0.2s;
    }

    .category-actions button:hover {
      background: #4a3aff;
      transform: scale(1.05);
    }

    /* ğŸ”¹ å¡ç‰‡å®¹å™¨ */
    .character-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
    }

    .character-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      padding: 16px;
      position: relative;
      cursor: pointer;
      transition: 0.2s;
    }

    .character-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .delete-character {
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 18px;
      background: none;
      border: none;
      cursor: pointer;
      transition: 0.2s;
    }

    .delete-character:hover {
      color: red;
      transform: scale(1.2);
    }

    /* ğŸ”¹ è©³æƒ…å¡ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 480px;
      padding: 20px;
      position: relative;
      animation: fadeIn 0.3s ease;
    }

    .modal-content h3 {
      color: #4a3aff;
      margin-top: 0;
    }

    .modal-content pre {
      background: #f7f7f7;
      border-radius: 10px;
      padding: 10px;
      overflow-x: auto;
      white-space: pre-wrap;
      box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.05);
    }

    .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      border: none;
      background: none;
      font-size: 20px;
      cursor: pointer;
      color: #777;
    }

    .close-btn:hover {
      color: #000;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

        /* ğŸ”¹ é€šç”¨å½ˆçª— */
    .dialog-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .dialog-box {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      padding: 20px;
      width: 90%;
      max-width: 400px;
      animation: fadeIn 0.3s ease;
    }

    .dialog-box h3 {
      margin-top: 0;
      color: #4a3aff;
      text-align: center;
    }

    .dialog-box input,
    .dialog-box textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .dialog-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }

    .dialog-buttons button {
      flex: 1;
      margin: 0 4px;
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn-confirm {
      background: linear-gradient(135deg, #7a7aff, #a479ff);
      color: white;
    }

    .btn-cancel {
      background: #ddd;
    }

    .btn-confirm:hover {
      transform: scale(1.05);
      box-shadow: 0 0 6px rgba(100, 80, 255, 0.5);
    }

    .btn-cancel:hover {
      background: #ccc;
    }

    /* ğŸ”¹ ç™»å…¥æ¡† */
    .login-container {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 3000;
    }

    .login-box {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      padding: 30px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }

    .login-box h2 {
      color: #4a3aff;
      margin-top: 0;
    }

    .login-box input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .login-box button {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      margin-top: 10px;
      cursor: pointer;
      transition: 0.2s;
      font-size: 15px;
    }

    .btn-login {
      background: linear-gradient(135deg, #7a7aff, #a479ff);
      color: white;
    }

    .btn-google {
      background: #fff;
      border: 1px solid #ccc;
    }

    .btn-google:hover {
      background: #eee;
    }

    /* ğŸ”¹ å³ä¸Šé¸å–®èˆ‡å›é ‚éƒ¨æŒ‰éˆ• */
    .top-menu {
      position: fixed;
      top: 10px;
      right: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1200;
    }

    .suggestion-button,
    .logout-button {
      border: none;
      background: linear-gradient(135deg, #7a7aff, #a479ff);
      color: white;
      border-radius: 20px;
      padding: 6px 14px;
      cursor: pointer;
      transition: 0.2s;
      font-size: 14px;
    }

    .suggestion-button:hover,
    .logout-button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 8px rgba(100, 80, 255, 0.4);
    }

    #backToTop {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(135deg, #7a7aff, #a479ff);
      color: white;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 18px;
      cursor: pointer;
      z-index: 1500;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: 0.3s;
    }

    #backToTop:hover {
      transform: scale(1.1);
    }
  </style>
</head>
<body>
  <h1>è§’è‰²ç®¡ç†å·¥å…·</h1>

  <div class="category-nav" id="categoryNav">
    <button id="addCategoryBtn">ï¼‹æ–°å¢åˆ†é¡</button>
  </div>

  <div id="content"></div>
  <button id="backToTop">â¬†</button>

    <div class="login-container" id="loginContainer">
    <div class="login-box">
      <h2>ç™»å…¥è§’è‰²ç®¡ç†å·¥å…·</h2>
      <input type="text" id="usernameInput" placeholder="å¸³è™Ÿ" />
      <input type="password" id="passwordInput" placeholder="å¯†ç¢¼" />
      <button class="btn-login" id="loginBtn">å¸³è™Ÿç™»å…¥ï¼è¨»å†Š</button>
      <button class="btn-google" id="googleLoginBtn">ä½¿ç”¨ Google ç™»å…¥</button>
    </div>
  </div>

  <!-- å°å»ºè­°å½ˆçª— -->
  <div class="dialog-overlay" id="suggestionOverlay">
    <div class="dialog-box">
      <h3>å°å»ºè­°</h3>
      <textarea id="suggestionInput" rows="4" placeholder="è¼¸å…¥æ‚¨çš„å»ºè­°..."></textarea>
      <div class="dialog-buttons">
        <button class="btn-confirm" id="submitSuggestion">é€å‡º</button>
        <button class="btn-cancel" id="cancelSuggestion">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      addDoc,
      deleteDoc,
      doc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      GoogleAuthProvider,
      signInWithPopup
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // ğŸ”¹ ä½ çš„ Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const categoryNav = document.getElementById("categoryNav");
    const content = document.getElementById("content");
    const addCategoryBtn = document.getElementById("addCategoryBtn");
    const loginContainer = document.getElementById("loginContainer");
    const loginBtn = document.getElementById("loginBtn");
    const googleLoginBtn = document.getElementById("googleLoginBtn");
    const usernameInput = document.getElementById("usernameInput");
    const passwordInput = document.getElementById("passwordInput");

    const suggestionOverlay = document.getElementById("suggestionOverlay");
    const suggestionInput = document.getElementById("suggestionInput");
    const submitSuggestion = document.getElementById("submitSuggestion");
    const cancelSuggestion = document.getElementById("cancelSuggestion");

    const backToTop = document.getElementById("backToTop");

    let currentUser = null;
    let categories = [];

    // ğŸ”¹ é¡¯ç¤ºç™»å…¥ç•«é¢
    const showLogin = () => {
      loginContainer.style.display = "flex";
    };

    // ğŸ”¹ ç™»å…¥ï¼è¨»å†ŠæŒ‰éˆ•
    loginBtn.addEventListener("click", async () => {
      const username = usernameInput.value.trim();
      const password = passwordInput.value;

      if (!username || !password) return alert("è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼ï¼");
      const email = `${username}@prompt.local`; // è‡ªå‹•è½‰æ›ç‚ºåˆæ³•æ ¼å¼

      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        if (error.code === "auth/user-not-found") {
          await createUserWithEmailAndPassword(auth, email, password);
        } else {
          alert("ç™»å…¥å¤±æ•—ï¼š" + error.message);
        }
      }
    });

    // ğŸ”¹ Google ç™»å…¥
    googleLoginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        alert("Google ç™»å…¥å¤±æ•—ï¼š" + error.message);
      }
    });

    // ğŸ”¹ ç™»å‡ºåŠŸèƒ½
    const logout = async () => {
      await signOut(auth);
    };

    // ğŸ”¹ å›é ‚éƒ¨æŒ‰éˆ•
    window.addEventListener("scroll", () => {
      if (window.scrollY > 300) backToTop.style.display = "block";
      else backToTop.style.display = "none";
    });
    backToTop.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // ğŸ”¹ å°å»ºè­°
    cancelSuggestion.addEventListener("click", () => {
      suggestionOverlay.style.display = "none";
      suggestionInput.value = "";
    });
    submitSuggestion.addEventListener("click", async () => {
      const text = suggestionInput.value.trim();
      if (!text) return alert("è«‹è¼¸å…¥å»ºè­°å…§å®¹ï¼");
      await addDoc(collection(db, "suggestions"), {
        suggestion: text,
        user: currentUser ? currentUser.email : "æœªç™»å…¥ä½¿ç”¨è€…",
        timestamp: serverTimestamp()
      });
      alert("å·²é€å‡ºå»ºè­°ï¼Œæ„Ÿè¬æ‚¨çš„å›é¥‹ï¼");
      suggestionOverlay.style.display = "none";
      suggestionInput.value = "";
    });

        // ğŸ”¹ ç™»å…¥ç‹€æ…‹ç›£è½
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        loginContainer.style.display = "none";
        renderTopMenu(user);
        await loadCategories();
      } else {
        currentUser = null;
        content.innerHTML = "";
        categoryNav.innerHTML = `<button id="addCategoryBtn">ï¼‹æ–°å¢åˆ†é¡</button>`;
        addCategoryBtn.addEventListener("click", showAddCategoryDialog);
        removeTopMenu();
        showLogin();
      }
    });

    // ğŸ”¹ å°è¦½åˆ—ä¸Šæ–¹é¸å–®ï¼ˆå°å»ºè­°ï¼ç™»å‡ºï¼‰
    const renderTopMenu = (user) => {
      removeTopMenu();
      const topMenu = document.createElement("div");
      topMenu.className = "top-menu";
      topMenu.innerHTML = `
        <span style="color:#555;font-size:14px;">${user.displayName || user.email.split("@")[0]}</span>
        <button class="suggestion-button" id="suggestionBtn">ğŸ’¬ å°å»ºè­°</button>
        <button class="logout-button" id="logoutBtn">ç™»å‡º</button>
      `;
      document.body.appendChild(topMenu);
      document.getElementById("suggestionBtn").addEventListener("click", () => {
        suggestionOverlay.style.display = "flex";
      });
      document.getElementById("logoutBtn").addEventListener("click", logout);
    };

    const removeTopMenu = () => {
      const old = document.querySelector(".top-menu");
      if (old) old.remove();
    };

    // ğŸ”¹ è¼‰å…¥åˆ†é¡
    async function loadCategories() {
      categoryNav.innerHTML = `<button id="addCategoryBtn">ï¼‹æ–°å¢åˆ†é¡</button>`;
      addCategoryBtn.addEventListener("click", showAddCategoryDialog);
      const querySnapshot = await getDocs(collection(db, "categories"));
      categories = [];
      content.innerHTML = "";

      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        categories.push({ id: docSnap.id, name: data.name });
      });

      // ä¾å»ºç«‹é †åºæ’åº
      categories.sort((a, b) => a.name === "è§’è‰²æè¿°" ? -1 : 1);

      categories.forEach((cat) => {
        renderCategory(cat);
        addNavButton(cat.name);
      });
    }

    // ğŸ”¹ å°è¦½åˆ—æŒ‰éˆ•
    function addNavButton(name) {
      const btn = document.createElement("button");
      btn.textContent = name;
      btn.addEventListener("click", () => {
        const section = document.getElementById(name);
        if (section) section.scrollIntoView({ behavior: "smooth" });
      });
      categoryNav.appendChild(btn);
    }

    // ğŸ”¹ æ–°å¢åˆ†é¡å°è©±æ¡†
    function showAddCategoryDialog() {
      const overlay = document.createElement("div");
      overlay.className = "dialog-overlay";
      overlay.style.display = "flex";
      overlay.innerHTML = `
        <div class="dialog-box">
          <h3>æ–°å¢åˆ†é¡</h3>
          <input id="newCategoryName" placeholder="è¼¸å…¥åˆ†é¡åç¨±..." />
          <div class="dialog-buttons">
            <button class="btn-confirm" id="confirmAddCategory">æ–°å¢</button>
            <button class="btn-cancel" id="cancelAddCategory">å–æ¶ˆ</button>
          </div>
        </div>`;
      document.body.appendChild(overlay);

      document.getElementById("cancelAddCategory").onclick = () => overlay.remove();
      document.getElementById("confirmAddCategory").onclick = async () => {
        const name = document.getElementById("newCategoryName").value.trim();
        if (!name) return alert("è«‹è¼¸å…¥åˆ†é¡åç¨±ï¼");
        await addDoc(collection(db, "categories"), { name });
        overlay.remove();
        await loadCategories();
      };
    }

    // ğŸ”¹ åˆ†é¡é¡¯ç¤º
    function renderCategory(cat) {
      const section = document.createElement("div");
      section.className = "category-section";
      section.id = cat.name;
      section.innerHTML = `
        <div class="category-header">
          <h2>${cat.name}</h2>
          <div class="category-actions">
            <button class="add-character">æ–°å¢</button>
            <button class="delete-category">ğŸ—‘ï¸</button>
          </div>
        </div>
        <div class="character-list" id="list-${cat.id}"></div>
      `;
      content.appendChild(section);

      section.querySelector(".add-character").addEventListener("click", () =>
        showAddCharacterDialog(cat.id)
      );
      section.querySelector(".delete-category").addEventListener("click", () =>
        confirmDeleteCategory(cat)
      );
    }

    // ğŸ”¹ åˆªé™¤åˆ†é¡
    async function confirmDeleteCategory(cat) {
      const input = prompt(`ç¢ºèªåˆªé™¤åˆ†é¡ã€Œ${cat.name}ã€ï¼Ÿè«‹è¼¸å…¥ã€Œåˆªé™¤ã€ä»¥ç¢ºèªã€‚`);
      if (input === "åˆªé™¤") {
        await deleteDoc(doc(db, "categories", cat.id));
        await loadCategories();
      }
    }

    // ğŸ”¹ æ–°å¢è§’è‰²å°è©±æ¡†
    function showAddCharacterDialog(categoryId) {
      const overlay = document.createElement("div");
      overlay.className = "dialog-overlay";
      overlay.style.display = "flex";
      overlay.innerHTML = `
        <div class="dialog-box">
          <h3>æ–°å¢è§’è‰²</h3>
          <input id="characterName" placeholder="è§’è‰²åç¨±" />
          <textarea id="characterPrompt" rows="4" placeholder="è§’è‰²æè¿°..."></textarea>
          <div class="dialog-buttons">
            <button class="btn-confirm" id="confirmAddCharacter">æ–°å¢</button>
            <button class="btn-cancel" id="cancelAddCharacter">å–æ¶ˆ</button>
          </div>
        </div>`;
      document.body.appendChild(overlay);

      document.getElementById("cancelAddCharacter").onclick = () => overlay.remove();
      document.getElementById("confirmAddCharacter").onclick = async () => {
        const name = document.getElementById("characterName").value.trim();
        const promptText = document.getElementById("characterPrompt").value.trim();
        if (!name || !promptText) return alert("è«‹è¼¸å…¥è§’è‰²åç¨±èˆ‡æè¿°ï¼");
        await addDoc(collection(db, `categories/${categoryId}/characters`), {
          name,
          prompt: promptText,
          createdAt: serverTimestamp()
        });
        overlay.remove();
        await loadCategories();
      };
    }

    // ğŸ”¹ è©³æƒ…å¡é¡¯ç¤º
    function showCharacterModal(name, promptText) {
      const modal = document.createElement("div");
      modal.className = "modal";
      modal.style.display = "flex";
      modal.innerHTML = `
        <div class="modal-content">
          <button class="close-btn">âœ•</button>
          <h3>${name}</h3>
          <pre>${promptText}</pre>
          <button class="btn-confirm" id="copyPrompt">ğŸ“‹ è¤‡è£½ Prompt</button>
        </div>
      `;
      document.body.appendChild(modal);
      modal.querySelector(".close-btn").onclick = () => modal.remove();
      modal.querySelector("#copyPrompt").onclick = () => {
        navigator.clipboard.writeText(promptText);
        alert("å·²è¤‡è£½ Promptï¼");
      };
    }
  </script>
</body>
</html>
