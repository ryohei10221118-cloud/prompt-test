<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
<title>è§’è‰²åˆ†é¡ç®¡ç†å·¥å…·</title>

<style>
:root {
  --primary: linear-gradient(135deg, #7b5cff, #6a9cff);
  --bg-color: #f4f5ff;
  --card-bg: #ffffff;
  --accent: #806cff;
  --shadow: rgba(0, 0, 0, 0.15);
  --gray-text: #555;
}

/* é é¢æ•´é«”è¨­å®š */
body {
  margin: 0;
  font-family: "Noto Sans TC", sans-serif;
  background: var(--bg-color);
  color: #222;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  overflow-x: hidden;
}

/* é é¦– */
header {
  width: 100%;
  text-align: center;
  background: var(--primary);
  color: white;
  padding: 18px 10px;
  font-size: clamp(1.3em, 2.5vw, 1.8em);
  font-weight: bold;
  letter-spacing: 1px;
  box-shadow: 0 3px 10px var(--shadow);
  position: sticky;
  top: 0;
  z-index: 100;
}

/* å°è¦½åˆ— */
.navbar {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  padding: 10px;
  justify-content: center;
  background: rgba(255,255,255,0.45);
  backdrop-filter: blur(6px);
  box-shadow: 0 2px 6px var(--shadow);
  width: 100%;
}
.navbar button {
  flex: 0 1 auto;
  border: none;
  background: var(--accent);
  color: white;
  padding: 8px 14px;
  border-radius: 20px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.2s ease;
  white-space: nowrap;
}
.navbar button:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

/* åˆ†é¡å®¹å™¨ */
.category {
  width: 95%;
  max-width: 1000px;
  background: var(--card-bg);
  margin: 18px auto;
  border-radius: 16px;
  box-shadow: 0 3px 10px var(--shadow);
  padding: 16px;
}

/* åˆ†é¡æ¨™é¡Œ */
.category-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 1.2em;
  font-weight: bold;
  color: var(--accent);
  margin-bottom: 10px;
  flex-wrap: wrap;
  gap: 10px;
}
.category-header button {
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 20px;
  padding: 6px 12px;
  cursor: pointer;
  font-size: 0.9em;
  margin-left: 5px;
}
.category-header button:hover {
  opacity: 0.9;
}
.category-header button.delete-btn {
  background: #ff4757;
}
.category-header button.add-char-btn {
  background: #1dd1a1;
}

/* å¡ç‰‡å€å¡Š */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 12px;
}
.card {
  background: white;
  border-radius: 14px;
  box-shadow: 0 3px 6px var(--shadow);
  padding: 14px;
  cursor: pointer;
  transition: 0.25s;
}
.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 12px var(--shadow);
}
.card-title {
  font-weight: bold;
  color: var(--accent);
  margin-bottom: 8px;
}
.card-desc {
  font-size: 0.95em;
  color: var(--gray-text);
  background: #f6f6ff;
  padding: 8px 10px;
  border-radius: 10px;
  min-height: 50px;
}

/* å½ˆçª—é€šç”¨ */
.modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.45);
  justify-content: center;
  align-items: center;
  z-index: 200;
}
.modal-content {
  background: white;
  padding: 25px;
  border-radius: 14px;
  box-shadow: 0 4px 10px var(--shadow);
  width: 90%;
  max-width: 420px;
  text-align: center;
  position: relative;
  max-height: 80vh;
  overflow-y: auto;
}
.modal-content h3 {
  margin-top: 0;
  color: var(--accent);
}
.modal-content input, .modal-content textarea {
  width: 90%;
  padding: 10px;
  margin-top: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 1em;
}
.modal-content button {
  margin-top: 15px;
  margin-left: 5px;
  margin-right: 5px;
  background: var(--primary);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
}
.modal-content button.delete-character-btn {
  background: #ff4757;
}
.modal-content button.btn-secondary {
  background: #95a5a6;
}
.close-btn {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 1.2em;
  cursor: pointer;
  color: #888;
}
.close-btn:hover { color: #000; }

/* å°å»ºè­°æŒ‰éˆ• */
#suggestionBtn {
  position: fixed;
  bottom: 25px;
  right: 25px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 50%;
  width: 55px;
  height: 55px;
  box-shadow: 0 4px 10px var(--shadow);
  font-size: 1.3em;
  cursor: pointer;
  z-index: 150;
  transition: 0.3s;
}
#suggestionBtn:hover { transform: scale(1.05); }

/* å›é ‚æŒ‰éˆ• */
#scrollTopBtn {
  position: fixed;
  bottom: 90px;
  right: 30px;
  background: #6a9cff;
  color: white;
  border: none;
  border-radius: 50%;
  width: 45px;
  height: 45px;
  font-size: 1.1em;
  cursor: pointer;
  display: none;
  box-shadow: 0 4px 10px var(--shadow);
  transition: 0.3s;
  z-index: 150;
}
#scrollTopBtn:hover { transform: scale(1.1); }

/* ç™»å…¥çª— */
#loginModal .modal-content {
  max-width: 360px;
}
#loginModal input {
  width: 90%;
  margin-bottom: 10px;
}
#loginModal button {
  width: 90%;
  margin-top: 10px;
}

/* è§’è‰²è©³æƒ…å½ˆçª—æ¨£å¼ */
.character-detail {
  background: #f2f2ff;
  padding: 15px;
  border-radius: 10px;
  margin: 15px 0;
  text-align: left;
  word-wrap: break-word;
  white-space: pre-wrap;
}

/* æ‰‹æ©Ÿé©æ‡‰ */
@media (max-width: 600px) {
  header { font-size: 1.5em; padding: 15px 8px; }
  .category { padding: 14px; }
  .navbar button { padding: 6px 10px; font-size: 0.9em; }
  .modal-content { width: 92%; padding: 20px; }
  .category-header { font-size: 1em; }
  .category-header button { font-size: 0.8em; padding: 5px 10px; }
}
</style>

</head>
<body>

<header>è§’è‰²ç®¡ç†å·¥å…·</header>

<!-- å°è¦½åˆ— -->
<div class="navbar">
  <button id="loginBtn">ç™»å…¥ / ç™»å‡º</button>
  <button id="addCategoryBtn">ï¼‹ æ–°å¢åˆ†é¡</button>
</div>

<!-- é¡åˆ¥å®¹å™¨ -->
<div id="categoriesContainer"></div>

<!-- å°å»ºè­°æŒ‰éˆ• -->
<button id="suggestionBtn" title="æå‡ºå°å»ºè­°">ğŸ’¡</button>

<!-- å›åˆ°æœ€ä¸Šæ–¹ -->
<button id="scrollTopBtn" title="å›åˆ°æœ€ä¸Šæ–¹">â†‘</button>

<!-- ç™»å…¥è¦–çª— -->
<div id="loginModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="closeLoginBtn">Ã—</span>
    <h3>ç™»å…¥æˆ–è¨»å†Šå¸³è™Ÿ</h3>
    <input type="text" id="loginAccount" placeholder="å¸³è™Ÿ" />
    <input type="password" id="loginPassword" placeholder="å¯†ç¢¼" />
    <button id="loginSubmitBtn">ç™»å…¥ / è¨»å†Š</button>
  </div>
</div>

<!-- å°å»ºè­°è¦–çª— -->
<div id="suggestionModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="closeSuggestionBtn">Ã—</span>
    <h3>æå‡ºå°å»ºè­°</h3>
    <textarea id="suggestionText" rows="5" placeholder="è¼¸å…¥ä½ çš„å»ºè­°..."></textarea>
    <button id="submitSuggestionBtn">é€å‡º</button>
  </div>
</div>

<!-- æ–°å¢åˆ†é¡è¦–çª— -->
<div id="addCategoryModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="closeAddCategoryBtn">Ã—</span>
    <h3>æ–°å¢åˆ†é¡</h3>
    <input type="text" id="categoryNameInput" placeholder="è«‹è¼¸å…¥åˆ†é¡åç¨±">
    <div>
      <button id="confirmAddCategory" class="btn-primary">æ–°å¢</button>
      <button id="cancelAddCategory" class="btn-secondary">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- æ–°å¢è§’è‰²è¦–çª— -->
<div id="addCharacterModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="closeAddCharacterBtn">Ã—</span>
    <h3>æ–°å¢è§’è‰²</h3>
    <input type="text" id="charName" placeholder="è§’è‰²åç¨±">
    <textarea id="charFull" rows="4" placeholder="è§’è‰²æè¿° / Prompt"></textarea>
    <div>
      <button id="saveCharacterBtn" class="btn-primary">æ–°å¢</button>
      <button id="cancelAddCharacter" class="btn-secondary">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script type="module">
// --- Firebase åˆå§‹åŒ– ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "ä½ çš„APIKEY",
  authDomain: "ä½ çš„å°ˆæ¡ˆ.firebaseapp.com",
  projectId: "ä½ çš„å°ˆæ¡ˆID",
  storageBucket: "ä½ çš„å°ˆæ¡ˆ.appspot.com",
  messagingSenderId: "ä½ çš„senderId",
  appId: "ä½ çš„appId"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// --- å…¨åŸŸè®Šæ•¸ ---
let currentUser = null;
let currentCategoryId = null;

// --- ç™»å…¥ / ç™»å‡º ---
const loginBtn = document.getElementById("loginBtn");
const loginModal = document.getElementById("loginModal");

loginBtn.addEventListener("click", () => {
  if (currentUser) {
    signOut(auth).then(() => {
      currentUser = null;
      alert("å·²ç™»å‡ºï¼");
      loginBtn.textContent = "ç™»å…¥ / ç™»å‡º";
      loadCategories();
    });
  } else {
    loginModal.style.display = "flex";
  }
});

document.getElementById("closeLoginBtn").addEventListener("click", () => {
  loginModal.style.display = "none";
});

document.getElementById("loginSubmitBtn").addEventListener("click", async () => {
  const account = document.getElementById("loginAccount").value;
  const password = document.getElementById("loginPassword").value;

  if (!account || !password) {
    alert("è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼ï¼");
    return;
  }

  try {
    await signInWithEmailAndPassword(auth, account, password);
    alert("ç™»å…¥æˆåŠŸï¼");
  } catch (error) {
    try {
      await createUserWithEmailAndPassword(auth, account, password);
      alert("è¨»å†ŠæˆåŠŸä¸¦å·²ç™»å…¥ï¼");
    } catch (registerError) {
      alert("ç™»å…¥/è¨»å†Šå¤±æ•—ï¼š" + registerError.message);
    }
  }
  loginModal.style.display = "none";
});

onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
    loginBtn.textContent = "ç™»å‡º (" + user.email + ")";
    loadCategories();
  } else {
    currentUser = null;
    loginBtn.textContent = "ç™»å…¥ / ç™»å‡º";
    loadCategories();
  }
});

// --- å°å»ºè­° ---
const suggestionModal = document.getElementById("suggestionModal");

document.getElementById("suggestionBtn").addEventListener("click", () => {
  suggestionModal.style.display = "flex";
});

document.getElementById("closeSuggestionBtn").addEventListener("click", () => {
  suggestionModal.style.display = "none";
});

document.getElementById("submitSuggestionBtn").addEventListener("click", async () => {
  const text = document.getElementById("suggestionText").value.trim();
  if (!text) {
    alert("è«‹è¼¸å…¥å…§å®¹ï¼");
    return;
  }
  try {
    await addDoc(collection(db, "suggestions"), {
      text,
      user: currentUser ? currentUser.email : "è¨ªå®¢",
      time: new Date()
    });
    alert("æ„Ÿè¬ä½ çš„å»ºè­°ï¼");
    document.getElementById("suggestionText").value = "";
    suggestionModal.style.display = "none";
  } catch (e) {
    console.error("Error adding suggestion: ", e);
    alert("é€å‡ºå¤±æ•—ï¼š" + e.message);
  }
});

// --- å›åˆ°æœ€ä¸Šæ–¹æŒ‰éˆ• ---
const scrollBtn = document.getElementById("scrollTopBtn");
window.addEventListener("scroll", () => {
  scrollBtn.style.display = window.scrollY > 200 ? "block" : "none";
});
scrollBtn.addEventListener("click", () => {
  window.scrollTo({ top: 0, behavior: "smooth" });
});

// --- è¼‰å…¥æ‰€æœ‰åˆ†é¡å’Œè§’è‰² ---
const categoriesContainer = document.getElementById("categoriesContainer");

async function loadCategories() {
  try {
    const q = query(collection(db, "categories"), orderBy("createdAt", "desc"));
    const querySnapshot = await getDocs(q);
    categoriesContainer.innerHTML = "";

    if (querySnapshot.empty) {
      categoriesContainer.innerHTML = "<p style='text-align:center; color:#999; margin-top:50px;'>å°šç„¡åˆ†é¡ï¼Œè«‹å…ˆæ–°å¢åˆ†é¡ï¼</p>";
      return;
    }

    querySnapshot.forEach((docSnap) => {
      const categoryData = docSnap.data();
      const categoryDiv = document.createElement("div");
      categoryDiv.className = "category";
      categoryDiv.id = `category-${docSnap.id}`;

      // é¡åˆ¥æ¨™é¡Œ
      const header = document.createElement("div");
      header.className = "category-header";

      const titleSpan = document.createElement("span");
      titleSpan.textContent = categoryData.name;
      header.appendChild(titleSpan);

      if (currentUser) {
        const buttonContainer = document.createElement("div");

        const addCharBtn = document.createElement("button");
        addCharBtn.className = "add-char-btn";
        addCharBtn.textContent = "â• æ–°å¢è§’è‰²";
        addCharBtn.onclick = () => showAddCharacter(docSnap.id);
        buttonContainer.appendChild(addCharBtn);

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.textContent = "ğŸ—‘ï¸ åˆªé™¤åˆ†é¡";
        deleteBtn.onclick = () => deleteCategory(docSnap.id);
        buttonContainer.appendChild(deleteBtn);

        header.appendChild(buttonContainer);
      }

      categoryDiv.appendChild(header);

      // è§’è‰²å¡ç‰‡ç¾¤
      const cardsDiv = document.createElement("div");
      cardsDiv.className = "cards";

      if (categoryData.characters && categoryData.characters.length > 0) {
        categoryData.characters.forEach((ch, index) => {
          const card = document.createElement("div");
          card.className = "card";

          const cardTitle = document.createElement("div");
          cardTitle.className = "card-title";
          cardTitle.textContent = ch.name;

          const cardDesc = document.createElement("div");
          cardDesc.className = "card-desc";
          cardDesc.textContent = ch.short || (ch.full ? ch.full.substring(0, 100) + "..." : "ç„¡æè¿°");

          card.appendChild(cardTitle);
          card.appendChild(cardDesc);
          card.onclick = () => showCharacterModal(ch, docSnap.id, index);
          cardsDiv.appendChild(card);
        });
      } else {
        cardsDiv.innerHTML = "<p style='color:#999; padding:20px; text-align:center;'>æ­¤åˆ†é¡å°šç„¡è§’è‰²</p>";
      }

      categoryDiv.appendChild(cardsDiv);
      categoriesContainer.appendChild(categoryDiv);
    });
  } catch (e) {
    console.error("Error loading categories: ", e);
    categoriesContainer.innerHTML = "<p style='text-align:center; color:red; margin-top:50px;'>è¼‰å…¥å¤±æ•—ï¼š" + e.message + "</p>";
  }
}

// --- é¡¯ç¤ºè§’è‰²è©³æƒ…ï¼ˆå«åˆªé™¤æŒ‰éˆ•ï¼‰ ---
function showCharacterModal(ch, categoryId, characterIndex) {
  const modal = document.createElement("div");
  modal.className = "modal";
  modal.style.display = "flex";

  const modalContent = document.createElement("div");
  modalContent.className = "modal-content";

  const closeBtn = document.createElement("span");
  closeBtn.className = "close-btn";
  closeBtn.textContent = "Ã—";
  closeBtn.onclick = () => modal.remove();

  const title = document.createElement("h3");
  title.textContent = ch.name;

  const detail = document.createElement("div");
  detail.className = "character-detail";
  detail.textContent = ch.full;

  const copyBtn = document.createElement("button");
  copyBtn.textContent = "ğŸ“‹ è¤‡è£½ Prompt";
  copyBtn.onclick = () => {
    navigator.clipboard.writeText(ch.full);
    alert("å·²è¤‡è£½ Promptï¼");
  };

  modalContent.appendChild(closeBtn);
  modalContent.appendChild(title);
  modalContent.appendChild(detail);
  modalContent.appendChild(copyBtn);

  // å¦‚æœæœ‰ç™»å…¥ï¼Œé¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
  if (currentUser) {
    const deleteBtn = document.createElement("button");
    deleteBtn.className = "delete-character-btn";
    deleteBtn.textContent = "ğŸ—‘ï¸ åˆªé™¤è§’è‰²";
    deleteBtn.onclick = () => deleteCharacter(categoryId, characterIndex, modal);
    modalContent.appendChild(deleteBtn);
  }

  modal.appendChild(modalContent);
  document.body.appendChild(modal);

  // é»æ“ŠèƒŒæ™¯é—œé–‰
  modal.onclick = (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  };
}

// --- åˆªé™¤è§’è‰² ---
async function deleteCharacter(categoryId, characterIndex, modal) {
  const input = prompt("ç¢ºèªåˆªé™¤è«‹è¼¸å…¥ã€Œåˆªé™¤ã€");
  if (input !== "åˆªé™¤") {
    alert("å–æ¶ˆåˆªé™¤");
    return;
  }

  try {
    const catRef = doc(db, "categories", categoryId);
    const catSnap = await getDoc(catRef);

    if (catSnap.exists()) {
      const existing = catSnap.data().characters || [];
      existing.splice(characterIndex, 1); // åˆªé™¤æŒ‡å®šç´¢å¼•çš„è§’è‰²
      await updateDoc(catRef, { characters: existing });
      alert("å·²åˆªé™¤è§’è‰²");
      modal.remove();
      loadCategories();
    }
  } catch (e) {
    console.error("Error deleting character:", e);
    alert("åˆªé™¤å¤±æ•—ï¼š" + e.message);
  }
}

// --- åˆªé™¤åˆ†é¡ ---
async function deleteCategory(id) {
  const input = prompt("ç¢ºèªåˆªé™¤è«‹è¼¸å…¥ã€Œåˆªé™¤ã€");
  if (input !== "åˆªé™¤") {
    alert("å–æ¶ˆåˆªé™¤");
    return;
  }

  try {
    await deleteDoc(doc(db, "categories", id));
    alert("å·²åˆªé™¤åˆ†é¡");
    loadCategories();
  } catch (e) {
    console.error("Error deleting category:", e);
    alert("åˆªé™¤å¤±æ•—ï¼š" + e.message);
  }
}

// --- æ–°å¢åˆ†é¡ ---
const addCategoryModal = document.getElementById("addCategoryModal");

document.getElementById("addCategoryBtn").addEventListener("click", () => {
  if (!currentUser) {
    alert("è«‹å…ˆç™»å…¥ï¼");
    return;
  }
  addCategoryModal.style.display = "flex";
});

document.getElementById("closeAddCategoryBtn").addEventListener("click", () => {
  addCategoryModal.style.display = "none";
});

document.getElementById("cancelAddCategory").addEventListener("click", () => {
  addCategoryModal.style.display = "none";
});

document.getElementById("confirmAddCategory").addEventListener("click", async () => {
  const name = document.getElementById("categoryNameInput").value.trim();
  if (!name) {
    alert("è«‹è¼¸å…¥åˆ†é¡åç¨±ï¼");
    return;
  }
  try {
    await addDoc(collection(db, "categories"), {
      name,
      createdAt: new Date(),
      characters: []
    });
    alert("åˆ†é¡æ–°å¢å®Œæˆï¼");
    addCategoryModal.style.display = "none";
    document.getElementById("categoryNameInput").value = "";
    loadCategories();
  } catch (e) {
    console.error("Error adding category:", e);
    alert("æ–°å¢å¤±æ•—ï¼š" + e.message);
  }
});

// --- æ–°å¢è§’è‰² ---
const addCharacterModal = document.getElementById("addCharacterModal");

function showAddCharacter(categoryId) {
  if (!currentUser) {
    alert("è«‹å…ˆç™»å…¥ï¼");
    return;
  }
  currentCategoryId = categoryId;
  document.getElementById("charName").value = "";
  document.getElementById("charFull").value = "";
  addCharacterModal.style.display = "flex";
}

document.getElementById("closeAddCharacterBtn").addEventListener("click", () => {
  addCharacterModal.style.display = "none";
});

document.getElementById("cancelAddCharacter").addEventListener("click", () => {
  addCharacterModal.style.display = "none";
});

document.getElementById("saveCharacterBtn").addEventListener("click", async () => {
  const name = document.getElementById("charName").value.trim();
  const full = document.getElementById("charFull").value.trim();

  if (!name || !full) {
    alert("è«‹å®Œæ•´å¡«å¯«è§’è‰²è³‡æ–™ï¼");
    return;
  }

  try {
    const catRef = doc(db, "categories", currentCategoryId);
    const catSnap = await getDoc(catRef);

    if (catSnap.exists()) {
      const existing = catSnap.data().characters || [];
      existing.push({
        name,
        short: full.substring(0, 100) + (full.length > 100 ? "..." : ""),
        full
      });
      await updateDoc(catRef, { characters: existing });
      alert("è§’è‰²æ–°å¢å®Œæˆï¼");
      addCharacterModal.style.display = "none";
      loadCategories();
    }
  } catch (e) {
    console.error("Error adding character:", e);
    alert("æ–°å¢å¤±æ•—ï¼š" + e.message);
  }
});

// åˆå§‹è¼‰å…¥
loadCategories();

</script>
</body>
</html>
